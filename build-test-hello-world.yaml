version: 1.0-preview-1
steps:
  # build website and func-test images, concurrently
  - id: build-hello-world
    build: -t {{.Run.Registry}}/hello-world:{{.Run.ID}} -f hello-world.dockerfile .
    when: ["-"]
  - id: build-hello-world-test
    build: -t hello-world-func-test  -f hello-world.dockerfile .
    when: ["-"]
  # run built images to be tested
  - id: hello-world
    cmd: {{.Run.Registry}}/hello-world:{{.Run.ID}}
    ports:
      - 8080:80
    when: ["build-hello-world"]
  - id: func-tests
    cmd: hello-world-func-test
    env:
      - TEST_TARGET_URL=hello-world
    when:
      - build-hello-world-test
      - hello-world

